<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Would You? - Party Game</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Reenie+Beanie&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        :root {
            --pink-hot: #ff006e;
            --pink-bright: #ff4d9c;
            --pink-soft: #ffb3d9;
            --pink-pale: #ffe4f2;
            --pink-deep: #c7004e;
            --cream: #fff8f0;
            --shadow: rgba(255, 0, 110, 0.25);
            --text-dark: #2d0a1f;
            --text-medium: #6b4458;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'DM Sans', sans-serif;
            background: linear-gradient(135deg, var(--pink-pale) 0%, var(--cream) 50%, var(--pink-soft) 100%);
            min-height: 100vh;
            color: var(--text-dark);
            overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 30%, rgba(255, 77, 156, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 0, 110, 0.08) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        .container {
            position: relative;
            z-index: 1;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .firebase-banner {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--pink-hot);
            color: white;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 500;
            box-shadow: 0 4px 20px var(--shadow);
            animation: slideInRight 0.5s ease-out, fadeOut 0.5s ease-in 2.5s forwards;
            z-index: 1000;
            font-size: 14px;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeOut {
            to {
                opacity: 0;
                transform: translateX(400px);
            }
        }
        
        .header {
            text-align: center;
            margin: 40px 0;
            animation: floatIn 0.8s ease-out;
        }
        
        @keyframes floatIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .header h1 {
            font-family: 'Reenie Beanie', cursive;
            font-size: 72px;
            color: var(--pink-hot);
            text-shadow: 3px 3px 0 var(--pink-soft);
            margin-bottom: 10px;
            transform: rotate(-2deg);
        }
        
        .header p {
            color: var(--text-medium);
            font-size: 18px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 10px 40px var(--shadow);
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 2px solid var(--pink-soft);
            animation: scaleIn 0.5s ease-out;
        }
        
        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .button {
            width: 100%;
            padding: 18px;
            font-size: 18px;
            font-weight: 700;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: 'DM Sans', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
        }
        
        .button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .button:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .button span {
            position: relative;
            z-index: 1;
        }
        
        .button-primary {
            background: linear-gradient(135deg, var(--pink-hot) 0%, var(--pink-bright) 100%);
            color: white;
            box-shadow: 0 6px 24px var(--shadow);
        }
        
        .button-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px var(--shadow);
        }
        
        .button-secondary {
            background: var(--pink-pale);
            color: var(--pink-deep);
            border: 2px solid var(--pink-soft);
            margin-top: 12px;
        }
        
        .button-secondary:hover {
            background: var(--pink-soft);
            border-color: var(--pink-bright);
        }
        
        .input-group {
            margin-bottom: 24px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-medium);
            font-weight: 500;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .input-group input {
            width: 100%;
            padding: 16px;
            border: 2px solid var(--pink-soft);
            border-radius: 12px;
            font-size: 16px;
            font-family: 'DM Sans', sans-serif;
            background: var(--cream);
            color: var(--text-dark);
            transition: all 0.3s ease;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: var(--pink-bright);
            background: white;
            box-shadow: 0 0 0 4px rgba(255, 77, 156, 0.1);
        }
        
        .room-code-display {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, var(--pink-hot), var(--pink-bright));
            border-radius: 20px;
            margin: 30px 0;
            box-shadow: 0 8px 32px var(--shadow);
        }
        
        .room-code-display .code {
            font-size: 48px;
            font-weight: 700;
            color: white;
            letter-spacing: 8px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
            margin: 10px 0;
        }
        
        .room-code-display .label {
            color: var(--pink-pale);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 500;
        }
        
        #qrcode {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            padding: 20px;
            background: white;
            border-radius: 16px;
            box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        #qrcode canvas {
            border-radius: 8px;
        }
        
        .question-card {
            background: var(--pink-hot);
            color: white;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            margin: 30px 0;
            box-shadow: 0 10px 40px var(--shadow);
            animation: questionPulse 0.6s ease-out;
        }
        
        @keyframes questionPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }
        
        .question-card h2 {
            font-size: 28px;
            line-height: 1.4;
            font-weight: 700;
        }
        
        .character-card {
            background: white;
            border: 3px solid var(--pink-soft);
            border-radius: 20px;
            padding: 24px;
            margin: 20px 0;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            animation: slideUp 0.4s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .character-card img {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 50%;
            border: 4px solid var(--pink-bright);
            margin-bottom: 16px;
        }
        
        .character-card h3 {
            font-size: 24px;
            color: var(--text-dark);
            margin-bottom: 20px;
        }
        
        .choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        .choice-button {
            padding: 16px;
            border: 2px solid;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
        }
        
        .choice-hard-yes {
            background: #00ff88;
            border-color: #00cc6a;
            color: #004d28;
        }
        
        .choice-hard-yes:hover { transform: scale(1.02); background: #00ff99; }
        
        .choice-yes {
            background: #b3ff99;
            border-color: #88dd66;
            color: #2d5016;
        }
        
        .choice-yes:hover { transform: scale(1.02); background: #c2ffaa; }
        
        .choice-indifferent {
            background: #ffeb99;
            border-color: #ddcc66;
            color: #665500;
        }
        
        .choice-indifferent:hover { transform: scale(1.02); background: #fff5aa; }
        
        .choice-no {
            background: #ffbb99;
            border-color: #dd8866;
            color: #662200;
        }
        
        .choice-no:hover { transform: scale(1.02); background: #ffccaa; }
        
        .choice-hard-no {
            background: #ff6b6b;
            border-color: #dd4444;
            color: #660000;
        }
        
        .choice-hard-no:hover { transform: scale(1.02); background: #ff7777; }
        
        .choice-button.selected {
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }
        
        .player-list {
            margin-top: 30px;
        }
        
        .player-item {
            background: var(--pink-pale);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 2px solid var(--pink-soft);
        }
        
        .player-name {
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .player-status {
            font-size: 14px;
            color: var(--text-medium);
        }
        
        .results-grid {
            display: grid;
            gap: 16px;
            margin-top: 20px;
        }
        
        .result-item {
            background: white;
            padding: 20px;
            border-radius: 16px;
            border: 2px solid var(--pink-soft);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        }
        
        .result-player {
            font-weight: 700;
            color: var(--pink-hot);
            margin-bottom: 8px;
            font-size: 18px;
        }
        
        .result-choice {
            font-size: 16px;
            padding: 8px 16px;
            border-radius: 8px;
            display: inline-block;
            font-weight: 600;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(45, 10, 31, 0.8);
            backdrop-filter: blur(4px);
            z-index: 1000;
            animation: fadeIn 0.3s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            border-radius: 24px;
            padding: 40px;
            max-width: 900px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideUp 0.4s ease-out;
        }
        
        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .modal-header h2 {
            color: var(--pink-hot);
            font-size: 28px;
        }
        
        .close-button {
            background: var(--pink-pale);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            color: var(--pink-hot);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .close-button:hover {
            background: var(--pink-soft);
            transform: rotate(90deg);
        }
        
        .character-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-top: 20px;
        }
        
        .add-character-section {
            margin-bottom: 30px;
            padding: 20px;
            background: var(--pink-pale);
            border-radius: 16px;
            border: 2px dashed var(--pink-bright);
        }
        
        .add-character-section h3 {
            color: var(--pink-hot);
            margin-bottom: 12px;
            font-size: 20px;
        }
        
        .add-character-form {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .add-character-form input {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--pink-soft);
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
        }
        
        .add-character-form input:focus {
            outline: none;
            border-color: var(--pink-bright);
        }
        
        .add-character-form button {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--pink-hot), var(--pink-bright));
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'DM Sans', sans-serif;
        }
        
        .add-character-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--shadow);
        }
        
        .bulk-import-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--pink-soft);
        }
        
        .bulk-import-section h4 {
            color: var(--text-dark);
            margin-bottom: 8px;
            font-size: 16px;
        }
        
        .bulk-import-section textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--pink-soft);
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
        }
        
        .bulk-import-section textarea:focus {
            outline: none;
            border-color: var(--pink-bright);
        }
        
        .bulk-import-section button {
            margin-top: 8px;
            padding: 10px 20px;
            background: var(--pink-bright);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'DM Sans', sans-serif;
        }
        
        .bulk-import-section button:hover {
            background: var(--pink-hot);
            transform: translateY(-2px);
        }
        
        .character-list-item {
            display: flex;
            flex-direction: column;
            padding: 16px;
            background: var(--pink-pale);
            border-radius: 16px;
            border: 2px solid var(--pink-soft);
            transition: all 0.3s ease;
            position: relative;
        }
        
        .character-list-item:hover {
            border-color: var(--pink-bright);
            box-shadow: 0 4px 16px var(--shadow);
        }
        
        .delete-character-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 28px;
            height: 28px;
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .delete-character-btn:hover {
            background: #ff5252;
            transform: scale(1.1);
        }
        
        .character-list-item .preview-container {
            width: 100%;
            height: 140px;
            background: white;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 2px solid var(--pink-soft);
            position: relative;
        }
        
        .character-list-item .preview-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }
        
        .character-list-item .preview-placeholder {
            color: var(--text-medium);
            font-size: 48px;
        }
        
        .character-list-item .upload-status {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #00ff88;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .character-list-item input {
            width: 100%;
            padding: 10px;
            border: 2px solid var(--pink-soft);
            border-radius: 8px;
            font-family: 'DM Sans', sans-serif;
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        .character-list-item input:focus {
            outline: none;
            border-color: var(--pink-bright);
        }
        
        .character-list-item .name {
            font-weight: 600;
            color: var(--text-dark);
            font-size: 14px;
            text-align: center;
            margin-bottom: 8px;
        }
        
        .waiting-text {
            text-align: center;
            color: var(--text-medium);
            font-size: 18px;
            margin: 20px 0;
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .manage-characters-button {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--pink-hot), var(--pink-bright));
            color: white;
            border: none;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 6px 24px var(--shadow);
            transition: all 0.3s ease;
            z-index: 100;
        }
        
        .manage-characters-button:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 8px 32px var(--shadow);
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="firebase-banner" id="firebaseBanner">Connected to Firebase ✓</div>
    
    <div class="container">
        <div class="header">
            <h1>Would You?</h1>
            <p>The ultimate party judgment game</p>
        </div>
        
        <!-- Home Screen -->
        <div id="homeScreen" class="card">
            <button class="button button-primary" onclick="showCreateRoom()"><span>Create Room & Play</span></button>
            <button class="button button-secondary" onclick="showJoinRoom()"><span>Join Existing Room</span></button>
        </div>
        
        <!-- Create Room Screen -->
        <div id="createRoomScreen" class="card hidden">
            <h2 style="color: var(--pink-hot); margin-bottom: 24px; font-size: 28px;">Create Room</h2>
            <div class="input-group">
                <label>Your Name</label>
                <input type="text" id="hostName" placeholder="Enter your name">
            </div>
            <button class="button button-primary" onclick="createRoom()"><span>Create Room</span></button>
            <button class="button button-secondary" onclick="showHome()"><span>Back</span></button>
        </div>
        
        <!-- Join Room Screen -->
        <div id="joinRoomScreen" class="card hidden">
            <h2 style="color: var(--pink-hot); margin-bottom: 24px; font-size: 28px;">Join Room</h2>
            <div class="input-group">
                <label>Your Name</label>
                <input type="text" id="playerName" placeholder="Enter your name">
            </div>
            <div class="input-group">
                <label>Room Code</label>
                <input type="text" id="roomCodeInput" placeholder="Enter 6-digit code" maxlength="6">
            </div>
            <button class="button button-primary" onclick="joinRoom()"><span>Join Game</span></button>
            <button class="button button-secondary" onclick="showHome()"><span>Back</span></button>
        </div>
        
        <!-- Lobby Screen -->
        <div id="lobbyScreen" class="card hidden">
            <h2 style="color: var(--pink-hot); margin-bottom: 24px; font-size: 28px;">Lobby</h2>
            <div class="room-code-display">
                <div class="label">Room Code</div>
                <div class="code" id="displayRoomCode"></div>
            </div>
            <div id="qrcode"></div>
            <div class="player-list" id="playerList"></div>
            <div id="hostControls" class="hidden">
                <button class="button button-primary" onclick="startGame()"><span>Start Game</span></button>
            </div>
            <button class="button button-secondary" onclick="leaveRoom()"><span>Leave Room</span></button>
        </div>
        
        <!-- Game Screen -->
        <div id="gameScreen" class="card hidden">
            <div class="question-card">
                <h2 id="questionText"></h2>
            </div>
            <div class="character-card">
                <img id="characterImage" src="" alt="Character">
                <h3 id="characterName"></h3>
                <div class="choice-buttons">
                    <button class="choice-button choice-hard-yes" onclick="makeChoice('hard-yes')">HARD YES</button>
                    <button class="choice-button choice-yes" onclick="makeChoice('yes')">Yes</button>
                    <button class="choice-button choice-indifferent" onclick="makeChoice('indifferent')">Truly Indifferent</button>
                    <button class="choice-button choice-no" onclick="makeChoice('no')">No</button>
                    <button class="choice-button choice-hard-no" onclick="makeChoice('hard-no')">HARD NO</button>
                </div>
            </div>
            <div class="waiting-text hidden" id="waitingText">Waiting for other players...</div>
        </div>
        
        <!-- Results Screen -->
        <div id="resultsScreen" class="card hidden">
            <h2 style="color: var(--pink-hot); margin-bottom: 24px; font-size: 28px; text-align: center;">Results</h2>
            <div class="character-card">
                <img id="resultsCharacterImage" src="" alt="Character">
                <h3 id="resultsCharacterName"></h3>
            </div>
            <div class="results-grid" id="resultsGrid"></div>
            <div id="hostNextRound" class="hidden">
                <button class="button button-primary" onclick="nextRound()"><span>Next Round</span></button>
                <button class="button button-secondary" onclick="endGame()"><span>End Game</span></button>
            </div>
            <div id="playerWaiting" class="hidden">
                <div class="waiting-text">Waiting for host to continue...</div>
            </div>
        </div>
    </div>
    
    <!-- Character Management Modal -->
    <div class="modal" id="characterModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Manage Characters</h2>
                <button class="close-button" onclick="closeCharacterModal()">×</button>
            </div>
            <div class="add-character-section">
                <h3>Add New Character</h3>
                <div class="add-character-form">
                    <input type="text" id="newCharacterName" placeholder="Character name (e.g., Mario, Pikachu)">
                    <button onclick="addNewCharacter()">Add Character</button>
                </div>
                <div class="bulk-import-section">
                    <h4>Bulk Import</h4>
                    <textarea id="bulkImportText" placeholder="Paste character names here (one per line)&#10;Example:&#10;Mario&#10;Luigi&#10;Princess Peach"></textarea>
                    <button onclick="bulkImportCharacters()">Import All</button>
                </div>
            </div>
            <div class="character-grid" id="characterImageInputs"></div>
        </div>
    </div>
    
    <button class="manage-characters-button" onclick="openCharacterModal()">⚙️</button>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCfrvPKRbhh-xjETGyCAkrqJwea1N0YFA0",
            authDomain: "wouldyou-61271.firebaseapp.com",
            databaseURL: "https://wouldyou-61271-default-rtdb.firebaseio.com",
            projectId: "wouldyou-61271",
            storageBucket: "wouldyou-61271.firebasestorage.app",
            messagingSenderId: "389428489709",
            appId: "1:389428489709:web:1bec3a0168f3f6586ecbe4",
            measurementId: "G-F811H9CKP1"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Hide banner after initialization
        setTimeout(() => {
            const banner = document.getElementById('firebaseBanner');
            if (banner) banner.style.display = 'none';
        }, 3000);

        // Question Pool
        const questions = [
            "Would you trust this person with your drink at the club?",
            "Would you let this person borrow your car for a week?",
            "Would you go on a road trip with this person?",
            "Would you let this person plan your birthday party?",
            "Would you trust this person to hide a body?",
            "Would you let this person cut your hair?",
            "Would you trust this person as your wingman/wingwoman?",
            "Would you let this person house-sit for you?",
            "Would you trust this person with a secret?",
            "Would you let this person pick your outfit for a date?",
            "Would you go camping in the woods with this person?",
            "Would you trust this person to make important life decisions for you?",
            "Would you let this person tattoo you?",
            "Would you survive a zombie apocalypse with this person?",
            "Would you trust this person to bail you out of jail?",
            "Would you let this person set you up on a blind date?",
            "Would you trust this person as your lawyer?",
            "Would you let this person cook Thanksgiving dinner?",
            "Would you go skydiving with this person?",
            "Would you trust this person to keep your plant alive?",
            "Would you let this person manage your social media for a week?",
            "Would you trust this person to watch your kids?",
            "Would you go into business with this person?",
            "Would you let this person choose your next job?",
            "Would you trust this person in a zombie outbreak?",
            "Would you let this person be your personal trainer?",
            "Would you trust this person with your Netflix password?",
            "Would you let this person give you relationship advice?",
            "Would you trust this person to plan your wedding?",
            "Would you let this person invest your money?",
            "Would you go bungee jumping with this person?",
            "Would you trust this person to keep a surprise party secret?",
            "Would you let this person redesign your room?",
            "Would you trust this person in a crisis?",
            "Would you let this person choose your next vacation destination?",
            "Would you trust this person to remember your birthday?",
            "Would you let this person write your dating profile?",
            "Would you trust this person to keep your diary safe?",
            "Would you let this person DJ your party?",
            "Would you trust this person in a trivia competition?",
            "Would you trust this person with your biggest insecurity?",
            "Would you let this person be your roommate?",
            "Would you trust this person to feed your pet while you're away?",
            "Would you let this person drive the getaway car?",
            "Would you go to a music festival with this person?",
            "Would you trust this person to delete your search history if you died?",
            "Would you let this person choose your next haircut?",
            "Would you trust this person to negotiate a raise for you?",
            "Would you let this person be your emergency contact?",
            "Would you go to Vegas with this person?",
            "Would you trust this person with your credit card?",
            "Would you let this person write your eulogy?",
            "Would you trust this person to keep you motivated?",
            "Would you let this person teach you to drive?",
            "Would you go ghost hunting with this person?",
            "Would you trust this person to remember your allergies?",
            "Would you let this person pick your college major?",
            "Would you trust this person in a drinking contest?",
            "Would you let this person do your makeup for a big event?",
            "Would you trust this person to roast you at your wedding?",
            "Would you go scuba diving with this person?",
            "Would you trust this person to walk you home alone at night?",
            "Would you let this person name your child?",
            "Would you trust this person with the aux cord on a road trip?",
            "Would you let this person be your wingperson at a bar?",
            "Would you trust this person to give you honest fashion advice?",
            "Would you let this person choose your next tattoo?",
            "Would you go backpacking through Europe with this person?",
            "Would you trust this person to help you move?",
            "Would you let this person babysit your younger sibling?",
            "Would you trust this person in a bar fight?",
            "Would you let this person give you a stick-and-poke tattoo?",
            "Would you trust this person to keep you awake on a road trip?",
            "Would you let this person run your Instagram for a day?",
            "Would you trust this person to edit your resume?",
            "Would you go to a haunted house with this person?",
            "Would you trust this person to order food for you?",
            "Would you let this person be your life coach?",
            "Would you trust this person in a trust fall?",
            "Would you let this person pick your next date?",
            "Would you trust this person with your phone unlocked?",
            "Would you let this person give you a piercing?",
            "Would you go white water rafting with this person?",
            "Would you trust this person to wake you up for something important?",
            "Would you let this person decorate your apartment?",
            "Would you trust this person to remember your drink order?",
            "Would you let this person give you a surprise makeover?",
            "Would you trust this person in an escape room?",
            "Would you let this person help you draft a breakup text?",
            "Would you trust this person to lie for you?",
            "Would you let this person teach your parents how to use technology?",
            "Would you trust this person to split the bill fairly?",
            "Would you go shark diving with this person?",
            "Would you trust this person to keep a wild night secret?",
            "Would you let this person be your workout buddy?",
            "Would you trust this person to give you a crash course before an exam?",
            "Would you let this person choose your next book to read?",
            "Would you trust this person with your embarrassing medical question?",
            "Would you let this person be your plus-one at a wedding?",
            "Would you trust this person to parallel park your car?"
        ];

        // Character Pool - will be loaded from Firebase
        let characters = [];
        
        // Load characters from Firebase on startup
        async function loadCharacters() {
            const charactersRef = database.ref('characters');
            const snapshot = await charactersRef.once('value');
            const firebaseCharacters = snapshot.val();
            
            if (firebaseCharacters && Array.isArray(firebaseCharacters) && firebaseCharacters.length > 0) {
                characters = firebaseCharacters;
            } else {
                // If no characters in Firebase, initialize with default list
                characters = [
                    "Tony Stark (Iron Man)",
                    "Hermione Granger (Harry Potter)",
                    "SpongeBob SquarePants",
                    "Batman",
                    "Elsa (Frozen)",
                    "Michael Scott (The Office)",
                    "Deadpool",
                    "Princess Leia",
                    "Homer Simpson",
                    "Wonder Woman",
                    "Shrek",
                    "Black Widow",
                    "Harry Potter",
                    "Dwight Schrute (The Office)",
                    "Captain America",
                    "Ariel (The Little Mermaid)",
                    "Walter White (Breaking Bad)",
                    "Mulan",
                    "Rick Sanchez (Rick and Morty)",
                    "Eleven (Stranger Things)",
                    "Thor",
                    "Katniss Everdeen (Hunger Games)",
                    "Peter Griffin (Family Guy)",
                    "Daenerys Targaryen (Game of Thrones)",
                    "Spider-Man (Peter Parker)",
                    "Loki",
                    "Ron Swanson (Parks and Recreation)",
                    "Moana",
                    "The Joker",
                    "Rey (Star Wars)",
                    "Bart Simpson",
                    "Jon Snow (Game of Thrones)",
                    "Leslie Knope (Parks and Recreation)",
                    "Doctor Strange",
                    "Rapunzel (Tangled)",
                    "Sheldon Cooper (Big Bang Theory)",
                    "Black Panther",
                    "Dory (Finding Nemo)",
                    "Goku (Dragon Ball)",
                    "Merida (Brave)",
                    "Han Solo",
                    "Buffy Summers (Buffy)",
                    "Naruto Uzumaki",
                    "Belle (Beauty and the Beast)",
                    "Sherlock Holmes",
                    "Ash Ketchum (Pokémon)",
                    "Tiana (Princess and the Frog)",
                    "The Doctor (Doctor Who)",
                    "Avatar Aang",
                    "Moira Rose (Schitt's Creek)",
                    "Chandler Bing (Friends)",
                    "Luke Skywalker",
                    "Scarlet Witch",
                    "Patrick Star",
                    "Catwoman",
                    "Aragorn (Lord of the Rings)",
                    "Buzz Lightyear",
                    "Harley Quinn",
                    "Geralt of Rivia (The Witcher)",
                    "Yoda",
                    "Jessica Rabbit",
                    "Iron Giant",
                    "Wolverine",
                    "Marge Simpson",
                    "Gamora",
                    "Sailor Moon",
                    "Gandalf",
                    "Pocahontas",
                    "Master Chief (Halo)",
                    "Gru (Despicable Me)",
                    "Vision",
                    "Finn (Adventure Time)",
                    "Legolas",
                    "Princess Peach",
                    "Godzilla",
                    "Luna Lovegood",
                    "Frodo Baggins",
                    "Sonic the Hedgehog",
                    "Draco Malfoy",
                    "Thanos",
                    "Luffy (One Piece)",
                    "Scar (The Lion King)",
                    "Elastigirl",
                    "Edward Scissorhands",
                    "Megamind",
                    "Indiana Jones",
                    "Speed Racer",
                    "Garfield",
                    "Vegeta (Dragon Ball)",
                    "Donkey (Shrek)",
                    "Steve (Minecraft)",
                    "Aladdin",
                    "Jack Sparrow",
                    "Neo (The Matrix)",
                    "Marty McFly",
                    "Groot",
                    "Rocket Raccoon",
                    "Shaggy (Scooby-Doo)",
                    "Bugs Bunny",
                    "Tom (Tom and Jerry)",
                    "Jerry (Tom and Jerry)",
                    "Po (Kung Fu Panda)",
                    "Simba",
                    "Tarzan",
                    "Jasmine",
                    "Flynn Rider",
                    "Kristoff (Frozen)",
                    "Olaf",
                    "Baymax",
                    "Stitch",
                    "Tinker Bell",
                    "Peter Pan",
                    "Captain Hook",
                    "Cruella de Vil",
                    "Maleficent",
                    "Ursula",
                    "Gaston",
                    "Jafar",
                    "Shere Khan",
                    "Yzma (Emperor's New Groove)",
                    "Kuzco (Emperor's New Groove)",
                    "Linguini (Ratatouille)",
                    "Remy (Ratatouille)",
                    "WALL-E",
                    "EVE (WALL-E)",
                    "Joy (Inside Out)",
                    "Sadness (Inside Out)",
                    "Anger (Inside Out)",
                    "Miguel (Coco)",
                    "Hector (Coco)",
                    "Edna Mode",
                    "Syndrome",
                    "Frozone",
                    "Bob Parr (Mr. Incredible)",
                    "Dash Parr",
                    "Violet Parr",
                    "Roz (Monsters Inc)",
                    "Mike Wazowski",
                    "Sulley",
                    "Boo (Monsters Inc)",
                    "Randall (Monsters Inc)",
                    "Rex (Toy Story)",
                    "Hamm (Toy Story)",
                    "Slinky Dog",
                    "Woody",
                    "Jessie (Toy Story)",
                    "Bo Peep",
                    "Sid (Toy Story)",
                    "Lotso",
                    "Ken (Toy Story)",
                    "Barbie (Toy Story)",
                    "Puss in Boots",
                    "Fiona (Shrek)",
                    "Lord Farquaad",
                    "Rumpelstiltskin",
                    "Hiccup (How to Train Your Dragon)",
                    "Toothless",
                    "Astrid (How to Train Your Dragon)",
                    "Alex (Madagascar)",
                    "Marty (Madagascar)",
                    "Gloria (Madagascar)",
                    "Melman (Madagascar)",
                    "King Julien",
                    "Skipper (Madagascar)"
                ];
                // Save default characters to Firebase
                await database.ref('characters').set(characters);
            }
            
            console.log('Loaded', characters.length, 'characters from Firebase');
        }
        
        // Call this on page load
        loadCharacters();

        // Game State
        let currentRoom = null;
        let currentPlayer = null;
        let isHost = false;
        let currentChoice = null;
        let usedQuestions = [];
        let usedCharacters = [];

        // Helper function to get random unused question
        function getRandomQuestion() {
            // If all questions used, reset the pool
            if (usedQuestions.length >= questions.length) {
                usedQuestions = [];
            }
            
            // Get available questions
            const availableQuestions = questions.filter(q => !usedQuestions.includes(q));
            const randomQuestion = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
            usedQuestions.push(randomQuestion);
            
            return randomQuestion;
        }

        // Helper function to get random unused character
        function getRandomCharacter() {
            // If all characters used, reset the pool
            if (usedCharacters.length >= characters.length) {
                usedCharacters = [];
            }
            
            // Get available characters
            const availableCharacters = characters.filter(c => !usedCharacters.includes(c));
            const randomCharacter = availableCharacters[Math.floor(Math.random() * availableCharacters.length)];
            usedCharacters.push(randomCharacter);
            
            return randomCharacter;
        }

        // Screen Navigation
        function showScreen(screenId) {
            document.querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
            document.getElementById(screenId).classList.remove('hidden');
        }

        function showHome() {
            showScreen('homeScreen');
            if (currentRoom) leaveRoom();
        }

        function showCreateRoom() {
            showScreen('createRoomScreen');
        }

        function showJoinRoom() {
            showScreen('joinRoomScreen');
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if (code) {
                document.getElementById('roomCodeInput').value = code;
            }
        }

        // Generate Room Code
        function generateRoomCode() {
            return Math.floor(100000 + Math.random() * 900000).toString();
        }

        // Create Room
        async function createRoom() {
            const hostName = document.getElementById('hostName').value.trim();
            if (!hostName) {
                alert('Please enter your name');
                return;
            }

            const roomCode = generateRoomCode();
            currentRoom = roomCode;
            currentPlayer = { id: Date.now().toString(), name: hostName };
            isHost = true;

            const roomData = {
                host: currentPlayer.id,
                players: {
                    [currentPlayer.id]: { name: hostName, ready: false }
                },
                status: 'lobby',
                createdAt: Date.now(),
                usedQuestions: [],
                usedCharacters: []
            };

            await database.ref('rooms/' + roomCode).set(roomData);
            
            document.getElementById('displayRoomCode').textContent = roomCode;
            
            // Generate QR Code
            const qrContainer = document.getElementById('qrcode');
            qrContainer.innerHTML = '';
            const url = window.location.origin + window.location.pathname + '?code=' + roomCode;
            new QRCode(qrContainer, {
                text: url,
                width: 200,
                height: 200,
                colorDark: "#ff006e",
                colorLight: "#ffffff"
            });

            showScreen('lobbyScreen');
            document.getElementById('hostControls').classList.remove('hidden');
            
            // Listen for player changes
            listenToLobby();
        }

        // Join Room
        async function joinRoom() {
            const playerName = document.getElementById('playerName').value.trim();
            const roomCode = document.getElementById('roomCodeInput').value.trim();

            if (!playerName || !roomCode) {
                alert('Please enter your name and room code');
                return;
            }

            const roomRef = database.ref('rooms/' + roomCode);
            const snapshot = await roomRef.once('value');

            if (!snapshot.exists()) {
                alert('Room not found');
                return;
            }

            currentRoom = roomCode;
            currentPlayer = { id: Date.now().toString(), name: playerName };
            isHost = false;

            await database.ref('rooms/' + roomCode + '/players/' + currentPlayer.id).set({
                name: playerName,
                ready: false
            });

            document.getElementById('displayRoomCode').textContent = roomCode;
            showScreen('lobbyScreen');
            
            listenToLobby();
        }

        // Listen to Lobby Updates
        function listenToLobby() {
            const playersRef = database.ref('rooms/' + currentRoom + '/players');
            playersRef.on('value', (snapshot) => {
                const players = snapshot.val();
                updatePlayerList(players);
            });

            // Listen for game start
            const statusRef = database.ref('rooms/' + currentRoom + '/status');
            statusRef.on('value', (snapshot) => {
                const status = snapshot.val();
                if (status === 'playing') {
                    showScreen('gameScreen');
                    loadRound();
                } else if (status === 'results') {
                    showResults();
                }
            });
        }

        // Update Player List
        function updatePlayerList(players) {
            const listContainer = document.getElementById('playerList');
            listContainer.innerHTML = '<h3 style="color: var(--pink-hot); margin-bottom: 16px;">Players</h3>';
            
            Object.entries(players).forEach(([id, player]) => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-item';
                playerDiv.innerHTML = `
                    <span class="player-name">${player.name}</span>
                    <span class="player-status">${player.choice ? '✓ Answered' : 'Waiting...'}</span>
                `;
                listContainer.appendChild(playerDiv);
            });
        }

        // Start Game
        async function startGame() {
            const playersRef = database.ref('rooms/' + currentRoom + '/players');
            const snapshot = await playersRef.once('value');
            const players = snapshot.val();

            if (Object.keys(players).length < 2) {
                alert('Need at least 2 players to start');
                return;
            }

            // Get room data to check used items
            const roomRef = database.ref('rooms/' + currentRoom);
            const roomSnapshot = await roomRef.once('value');
            const roomData = roomSnapshot.val();
            
            // Load used questions and characters from Firebase
            usedQuestions = roomData.usedQuestions || [];
            usedCharacters = roomData.usedCharacters || [];

            const randomQuestion = getRandomQuestion();
            const randomCharacter = getRandomCharacter();

            await database.ref('rooms/' + currentRoom).update({
                status: 'playing',
                currentQuestion: randomQuestion,
                currentCharacter: randomCharacter,
                round: 1,
                usedQuestions: usedQuestions,
                usedCharacters: usedCharacters
            });

            // Clear previous choices
            Object.keys(players).forEach(playerId => {
                database.ref('rooms/' + currentRoom + '/players/' + playerId).update({
                    choice: null
                });
            });
        }

        // Load Round
        async function loadRound() {
            const roomRef = database.ref('rooms/' + currentRoom);
            const snapshot = await roomRef.once('value');
            const roomData = snapshot.val();

            document.getElementById('questionText').textContent = roomData.currentQuestion;
            document.getElementById('characterName').textContent = roomData.currentCharacter;
            
            // Load character image from Firebase
            const characterImagesRef = database.ref('characterImages/' + roomData.currentCharacter);
            const imageSnapshot = await characterImagesRef.once('value');
            const imageData = imageSnapshot.val();
            
            if (imageData) {
                document.getElementById('characterImage').src = imageData;
            } else {
                document.getElementById('characterImage').src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><rect width="120" height="120" fill="%23ffb3d9"/><text x="60" y="60" font-size="40" text-anchor="middle" dy=".3em" fill="%23ff006e">?</text></svg>';
            }

            currentChoice = null;
            document.querySelectorAll('.choice-button').forEach(btn => btn.classList.remove('selected'));
            document.getElementById('waitingText').classList.add('hidden');

            // Listen for all players to answer
            listenForAllAnswers();
        }

        // Make Choice
        async function makeChoice(choice) {
            currentChoice = choice;
            
            // Update UI
            document.querySelectorAll('.choice-button').forEach(btn => btn.classList.remove('selected'));
            event.target.classList.add('selected');

            // Save to Firebase
            await database.ref('rooms/' + currentRoom + '/players/' + currentPlayer.id).update({
                choice: choice
            });

            document.getElementById('waitingText').classList.remove('hidden');
        }

        // Listen for All Answers
        function listenForAllAnswers() {
            const playersRef = database.ref('rooms/' + currentRoom + '/players');
            playersRef.on('value', async (snapshot) => {
                const players = snapshot.val();
                const allAnswered = Object.values(players).every(p => p.choice);

                if (allAnswered && isHost) {
                    await database.ref('rooms/' + currentRoom).update({
                        status: 'results'
                    });
                }
            });
        }

        // Show Results
        async function showResults() {
            showScreen('resultsScreen');
            
            const roomRef = database.ref('rooms/' + currentRoom);
            const snapshot = await roomRef.once('value');
            const roomData = snapshot.val();

            document.getElementById('resultsCharacterName').textContent = roomData.currentCharacter;
            
            // Load character image
            const characterImagesRef = database.ref('characterImages/' + roomData.currentCharacter);
            const imageSnapshot = await characterImagesRef.once('value');
            const imageData = imageSnapshot.val();
            
            if (imageData) {
                document.getElementById('resultsCharacterImage').src = imageData;
            } else {
                document.getElementById('resultsCharacterImage').src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120"><rect width="120" height="120" fill="%23ffb3d9"/><text x="60" y="60" font-size="40" text-anchor="middle" dy=".3em" fill="%23ff006e">?</text></svg>';
            }

            const resultsGrid = document.getElementById('resultsGrid');
            resultsGrid.innerHTML = '';

            const choiceColors = {
                'hard-yes': '#00ff88',
                'yes': '#b3ff99',
                'indifferent': '#ffeb99',
                'no': '#ffbb99',
                'hard-no': '#ff6b6b'
            };

            const choiceLabels = {
                'hard-yes': 'HARD YES',
                'yes': 'Yes',
                'indifferent': 'Truly Indifferent',
                'no': 'No',
                'hard-no': 'HARD NO'
            };

            Object.entries(roomData.players).forEach(([id, player]) => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'result-item';
                resultDiv.innerHTML = `
                    <div class="result-player">${player.name}</div>
                    <div class="result-choice" style="background: ${choiceColors[player.choice]}; color: #2d0a1f;">
                        ${choiceLabels[player.choice]}
                    </div>
                `;
                resultsGrid.appendChild(resultDiv);
            });

            if (isHost) {
                document.getElementById('hostNextRound').classList.remove('hidden');
                document.getElementById('playerWaiting').classList.add('hidden');
            } else {
                document.getElementById('hostNextRound').classList.add('hidden');
                document.getElementById('playerWaiting').classList.remove('hidden');
            }
        }

        // Next Round
        async function nextRound() {
            // Get room data to check used items
            const roomRef = database.ref('rooms/' + currentRoom);
            const roomSnapshot = await roomRef.once('value');
            const roomData = roomSnapshot.val();
            
            // Load used questions and characters from Firebase
            usedQuestions = roomData.usedQuestions || [];
            usedCharacters = roomData.usedCharacters || [];

            const randomQuestion = getRandomQuestion();
            const randomCharacter = getRandomCharacter();

            const playersRef = database.ref('rooms/' + currentRoom + '/players');
            const snapshot = await playersRef.once('value');
            const players = snapshot.val();

            // Clear choices
            Object.keys(players).forEach(playerId => {
                database.ref('rooms/' + currentRoom + '/players/' + playerId).update({
                    choice: null
                });
            });

            await database.ref('rooms/' + currentRoom).update({
                status: 'playing',
                currentQuestion: randomQuestion,
                currentCharacter: randomCharacter,
                usedQuestions: usedQuestions,
                usedCharacters: usedCharacters
            });

            showScreen('gameScreen');
            loadRound();
        }

        // End Game
        async function endGame() {
            await database.ref('rooms/' + currentRoom).update({
                status: 'lobby'
            });
            showScreen('lobbyScreen');
        }

        // Leave Room
        async function leaveRoom() {
            if (currentRoom && currentPlayer) {
                await database.ref('rooms/' + currentRoom + '/players/' + currentPlayer.id).remove();
                
                if (isHost) {
                    await database.ref('rooms/' + currentRoom).remove();
                }
            }
            
            currentRoom = null;
            currentPlayer = null;
            isHost = false;
            showScreen('homeScreen');
        }

        // Character Management
        async function addNewCharacter() {
            const input = document.getElementById('newCharacterName');
            const characterName = input.value.trim();
            
            if (!characterName) {
                alert('Please enter a character name');
                return;
            }
            
            // Check if character already exists
            if (characters.includes(characterName)) {
                alert('This character already exists!');
                return;
            }
            
            // Add to local array
            characters.push(characterName);
            
            // Save to Firebase
            await database.ref('characters').set(characters);
            
            // Clear input
            input.value = '';
            
            // Refresh the modal while preserving scroll
            await refreshCharacterGrid();
        }
        
        async function bulkImportCharacters() {
            const textarea = document.getElementById('bulkImportText');
            const text = textarea.value.trim();
            
            if (!text) {
                alert('Please enter character names (one per line)');
                return;
            }
            
            // Split by newlines and clean up
            const newCharacters = text
                .split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            if (newCharacters.length === 0) {
                alert('No valid character names found');
                return;
            }
            
            // Filter out duplicates
            const uniqueNew = newCharacters.filter(char => !characters.includes(char));
            
            if (uniqueNew.length === 0) {
                alert('All characters already exist!');
                return;
            }
            
            // Add all new characters
            characters.push(...uniqueNew);
            
            // Save to Firebase
            await database.ref('characters').set(characters);
            
            // Clear textarea
            textarea.value = '';
            
            alert(`Successfully added ${uniqueNew.length} character(s)!`);
            
            // Refresh the modal while preserving scroll
            await refreshCharacterGrid();
        }
        
        async function deleteCharacter(characterName, index) {
            if (!confirm(`Are you sure you want to permanently delete "${characterName}"? This will also delete their image.`)) {
                return;
            }
            
            // Save current scroll position
            const modalContent = document.querySelector('.modal-content');
            const scrollPosition = modalContent.scrollTop;
            
            // Remove from local array
            characters.splice(index, 1);
            
            // Save updated array to Firebase
            await database.ref('characters').set(characters);
            
            // Also delete the character's image
            await database.ref('characterImages/' + characterName).remove();
            
            // Refresh the modal
            await refreshCharacterGrid();
            
            // Restore scroll position
            requestAnimationFrame(() => {
                modalContent.scrollTop = scrollPosition;
            });
        }
        
        async function refreshCharacterGrid() {
            const container = document.getElementById('characterImageInputs');
            container.innerHTML = '';

            for (let i = 0; i < characters.length; i++) {
                const character = characters[i];
                
                const itemDiv = document.createElement('div');
                itemDiv.className = 'character-list-item';
                
                // Add delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-character-btn';
                deleteBtn.innerHTML = '×';
                deleteBtn.title = 'Delete character';
                deleteBtn.onclick = function() {
                    deleteCharacter(character, i);
                };
                itemDiv.appendChild(deleteBtn);
                
                const previewContainer = document.createElement('div');
                previewContainer.className = 'preview-container';
                previewContainer.id = `preview-${i}`;
                previewContainer.innerHTML = '<div class="preview-placeholder">?</div>';
                
                itemDiv.appendChild(previewContainer);
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'name';
                nameDiv.textContent = character;
                itemDiv.appendChild(nameDiv);
                
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = 'Paste image URL';
                input.dataset.character = character;
                input.dataset.index = i;
                input.onchange = function() {
                    saveCharacterImage(this.dataset.character, this.value, this.dataset.index);
                };
                itemDiv.appendChild(input);
                
                container.appendChild(itemDiv);
            }

            // Now load images asynchronously after all cards are displayed
            for (let i = 0; i < characters.length; i++) {
                const character = characters[i];
                const characterImagesRef = database.ref('characterImages/' + character);
                characterImagesRef.once('value').then(snapshot => {
                    const existingImage = snapshot.val();
                    const previewContainer = document.getElementById(`preview-${i}`);
                    const input = document.querySelector(`input[data-index="${i}"]`);
                    
                    if (existingImage && previewContainer && input) {
                        input.value = existingImage;
                        
                        const img = document.createElement('img');
                        img.src = existingImage;
                        img.onerror = function() {
                            this.parentElement.innerHTML = '<div class="preview-placeholder">?</div>';
                        };
                        previewContainer.innerHTML = '';
                        previewContainer.appendChild(img);
                        
                        const uploadStatus = document.createElement('div');
                        uploadStatus.className = 'upload-status';
                        uploadStatus.textContent = '✓';
                        uploadStatus.title = 'Image uploaded';
                        previewContainer.appendChild(uploadStatus);
                    }
                });
            }
        }
        
        async function openCharacterModal() {
            const modal = document.getElementById('characterModal');
            modal.classList.add('active');
            
            const container = document.getElementById('characterImageInputs');
            container.innerHTML = `<div style="text-align: center; padding: 40px; color: var(--text-medium);">Loading ${characters.length} characters...</div>`;

            // Small delay to show modal immediately
            await new Promise(resolve => setTimeout(resolve, 10));

            console.log('Total characters:', characters.length);

            await refreshCharacterGrid();
        }

        function closeCharacterModal() {
            document.getElementById('characterModal').classList.remove('active');
        }

        async function saveCharacterImage(characterName, imageUrl, index) {
            const previewContainer = document.getElementById(`preview-${index}`);
            
            if (imageUrl) {
                // Test if image loads
                const testImg = new Image();
                testImg.onload = async function() {
                    await database.ref('characterImages/' + characterName).set(imageUrl);
                    
                    // Update preview
                    previewContainer.innerHTML = '';
                    const img = document.createElement('img');
                    img.src = imageUrl;
                    previewContainer.appendChild(img);
                    
                    const uploadStatus = document.createElement('div');
                    uploadStatus.className = 'upload-status';
                    uploadStatus.textContent = '✓';
                    uploadStatus.title = 'Image uploaded successfully';
                    previewContainer.appendChild(uploadStatus);
                    
                    // Briefly highlight the card
                    const card = previewContainer.parentElement;
                    card.style.border = '2px solid #00ff88';
                    setTimeout(() => {
                        card.style.border = '2px solid var(--pink-soft)';
                    }, 1000);
                };
                testImg.onerror = function() {
                    alert('Failed to load image. Please check the URL.');
                    previewContainer.innerHTML = '<div class="preview-placeholder">❌</div>';
                };
                testImg.src = imageUrl;
            } else {
                await database.ref('characterImages/' + characterName).remove();
                previewContainer.innerHTML = '<div class="preview-placeholder">?</div>';
            }
        }

        // Close modal on outside click
        document.getElementById('characterModal').addEventListener('click', (e) => {
            if (e.target.id === 'characterModal') {
                closeCharacterModal();
            }
        });

        // Auto-fill room code from URL on page load
        window.addEventListener('load', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            if (code) {
                showJoinRoom();
            }
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (currentRoom && currentPlayer) {
                leaveRoom();
            }
        });
    </script>
</body>
</html>
